<html>
  <Head>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/static/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="/static/css/katex.min.css"/>
    <link rel="stylesheet" href="/static/css/wiki.css"/>
    <link rel="stylesheet" href="/static/css/codehilite.css"/>

    <script src="/static/js/katex.min.js"></script>
    <script src="/static/js/jquery.min.js"></script>
    
    
<link rel="stylesheet" href="/static/css/slides.css"/>


    <title>PA é€‰è®²</title>
  </Head>
  <body>
   
   
<textarea id="source">
public: true
class: center, middle

# PA é€‰è®²

æ¬§å…ˆé£ <ouxianfei@smail.nju.edu.cn>

å—äº¬å¤§å­¦è®¡ç®—æœºè½¯ä»¶ç ”ç©¶æ‰€

---

# æçº²

* yemuåˆ°nemu
* nemuä¸­çš„è¯‘ç æ‰§è¡Œè§£è€¦åˆ
* nemuä¸­çš„ç¡¬ä»¶æ¨¡æ‹Ÿ
* JITåˆæ­¥
* nemuä¸­çš„å·®åˆ†æµ‹è¯•

----

* slidesä¸‹è½½åœ°å€ï¼š114.212.83.188:8080/Thursday-slides.7z
 * `php -S localhost:8080 -t $PWD`

---

# å¿…è¦çš„å¤ä¹ 

å¦‚ä½•è°ƒè¯•segment faultï¼Ÿ (å…¶å®[ä¹‹å‰](http://114.212.81.193:5000/wiki/ICS2018_6.slides#25)è’‹ç¥å·²ç»è®²è¿‡)

```bash
Program received signal SIGSEGV, Segmentation fault.
exec_wrapper (print_flag=print_flag@entry=0 '\000') at src/cpu/exec/exec.c:248
248       *(uint32_t *)0x12345678 = 0x12345678;
(gdb) bt
#0  exec_wrapper (print_flag=print_flag@entry=0 '\000') at src/cpu/exec/exec.c:248
#1  0x000055555555b717 in cpu_exec (n=n@entry=18446744073709551615) at src/monitor/cpu-exec.c:38
#2  0x000055555555bcc0 in cmd_c (args=<optimized out>) at src/monitor/debug/ui.c:31
#3  0x000055555555bfa7 in ui_mainloop (is_batch_mode=<optimized out>) at src/monitor/debug/ui.c:108
#4  0x000055555555ac50 in main (argc=<optimized out>, argv=<optimized out>) at src/main.c:9
(gdb)
```

---

# yemuåˆ°nemuä¹‹é—´è¿˜æœ‰å¤šè¿œï¼Ÿ

é¦–å…ˆæˆ‘ä»¬å‡†å¤‡å¥½è½®å»“(yemu)

<img class="pull-bottom" src="/static/image/draw_horse_1.png"/>

---

# yemuåˆ°nemuä¹‹é—´è¿˜æœ‰å¤šè¿œï¼Ÿ

ç„¶åæˆ‘ä»¬è¡¥å……ç‚¹ç»†èŠ‚

<img class="pull-bottom" src="/static/image/draw_horse_2.png"/>

---

# yemuåˆ°nemuä¹‹é—´è¿˜æœ‰å¤šè¿œï¼Ÿ

ç»†èŠ‚ä¹Ÿæ˜¯ä¸€æ­¥ä¸€æ­¥æ¥çš„

<center>
<img class="pull-bottom" src="/static/image/draw_horse_3.jpg"/>
</center>

---
class: center, middle

# yemuåˆ°nemuçš„è¿›åŒ–ï¼ˆä¼ªï¼‰

---

# ä¼¼ä¹ä¸æ€ä¹ˆworkçš„ç¬¬ä¸€ç‰ˆ


```c
typedef union inst {
  struct { u8 rs  : 2, rt: 2, op: 4; } rtype;
  struct { u8 addr: 4,        op: 4; } mtype;
} inst_t;

#define RTYPE(i) u8 rt = (i)->rtype.rt, rs = (i)->rtype.rs;
#define MTYPE(i) u8 addr = (i)->mtype.addr;

void execute() {
  inst_t *cur = (inst_t *)&M[pc];
  switch (cur->rtype.op) {
  case 0b0000: { RTYPE(cur); R[rt]   = R[rs];   pc++; break; }
  case 0b0001: { RTYPE(cur); R[rt]  += R[rs];   pc++; break; }
  case 0b1110: { MTYPE(cur); R[0]    = M[addr]; pc++; break; }
  case 0b1111: { MTYPE(cur); M[addr] = R[0];    pc++; break; }
  default: assert(0);
  }
}
```

---

# å¯¹æ¥å®Œx86æ‰‹å†Œ

```c
typedef int (*helper_fun)(swaddr_t);

int inv(swaddr_t eip) { assert(0); }
int add_r2rm_b(swaddr_t eip) { /* ... */ }
int add_r2rm_v(swaddr_t eip) { /* ... */ }
int add_rm2r_b(swaddr_t eip) { /* ... */ }
// ...

helper_fun opcode_table [256] = {
/* 0x00 */	add_r2rm_b, add_r2rm_v, add_rm2r_b, add_rm2r_v,
/* 0x04 */	add_i2a_b, add_i2a_v, inv, inv,
/* .... */  // ...
};

int exec() {
  uint8_t op = instr_fetch(eip, 1);
  return opcode_table[op](eip);
}
```

---

# å¯¹æ¥å®Œx86æ‰‹å†Œ

ç¬¦åˆx86æ‰‹å†Œ
* è‡ªå®šä¹‰çš„è™šæ‹Ÿæœºæ“ä½œç  -> x86æ ‡å‡†çš„æ“ä½œç 

--
count: false

ä»£ç é£æ ¼
* `switch-case` å˜æ›´æˆäº† `opcode_table`
* æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

--
count: false
æœªå®ç°æŒ‡ä»¤
* ç”¨`inv`ä»£æ›¿ï¼Œ`inv`ç›´æ¥`assert(0)`
* é¢„é˜²äºæœªç„¶(ä¸ç„¶ç¨‹åºè·‘é£äº†éƒ½ä¸çŸ¥é“é”™åœ¨å“ª)
* é™¤äº†ç›´æ¥`assert(0)`è¿˜å¯ä»¥åšäº›ä»€ä¹ˆï¼Ÿ

---

# æ›´å‹å¥½çš„inv
PA2æœ€å¤´ç–¼çš„åœ°æ–¹(å…¶å®åŒ…å«ç€yzhå­¦é•¿æ»¡æ»¡çš„äººæ–‡å…³æ€€)

```bash
If it is the first case, see
 _ ____   ___    __    __  __                         _ 
(_)___ \ / _ \  / /   |  \/  |                       | |
 _  __) | (_) |/ /_   | \  / | __ _ _ __  _   _  __ _| |
| ||__ < > _ <| '_ \  | |\/| |/ _` | '_ \| | | |/ _` | |
| |___) | (_) | (_) | | |  | | (_| | | | | |_| | (_| | |
|_|____/ \___/ \___/  |_|  |_|\__,_|_| |_|\__,_|\__,_|_|

for more details.

If it is the second case, remember:
* The machine is always right!
* Every line of untested code is always wrong!

nemu: ABORT at eip = 0x00100012
```

---
class: center, middle

# è§£è€¦åˆçš„å¿…è¦æ€§

---

# copy-pasteæ¨¡å¼çš„ç¬¬ä¸€ç‰ˆ

æˆ‘ä»¬éœ€è¦å®ç°`add`æŒ‡ä»¤
* å…ˆæŒ‰æ‰‹å†Œå†™ä¸€ä¸ª`add_r2rm_b`

--
count: false
å¾ˆå¿«æˆ‘ä»¬å‘ç°

--
count: false
* `add_r2rm_v`å¥½åƒå¯ä»¥æŠŠ`add_r2rm_b`æ‹·è¿‡å»ç¨å¾®æ”¹æ”¹

--
count: false

* `add_rm2r_b`å¥½åƒä¹Ÿå¯ä»¥æŠŠ`add_r2rm_b`æ‹·è¿‡å»ç¨å¾®æ”¹æ”¹
--
count: false

* `add_rm2r_v`å¥½åƒä¹Ÿå¯ä»¥...
--
count: false

ç´§æ¥ç€æˆ‘ä»¬å‘ç°
* `sub_r2rm_v`å¥½åƒä¹Ÿå¯ä»¥æŠŠ`add_r2rm_b`æ‹·è¿‡å»ç¨å¾®æ”¹æ”¹
* `sub_rm2r_r`, `sub_rm2r_v`...

--
count: false
æœ€åæˆ‘ä»¬å‘ç°
* å‡ ä¹æ‰€æœ‰ç®—æœ¯æŒ‡ä»¤éƒ½å¯ä»¥è¿™æ ·å¹²

---

# copy-pasteä¸€æ—¶çˆ½

ä»…åˆåŠä¸ªå°æ—¶ï¼Œæˆ‘ä»¬ä¾¿å®ç°äº†xxxæ¡æŒ‡ä»¤

<img class="pull-bottom" src="/static/image/copy_paste.png"/>

---

# debugæ—¶ç«è‘¬åœº

æŸä¸€å¤©ä½ å‘ç°addçš„æŸæ¡æŒ‡ä»¤çš„æ“ä½œæ•°æ‰©å±•æ–¹å¼å†™é”™äº†ï¼Œè€Œä¸”éå¸¸é—æ†¾çš„æ˜¯å…¶å®ƒç®—æœ¯æŒ‡ä»¤ç›´æ¥æ‹·è´äº†è¿™ä¸€ä»½ä»£ç ã€‚ä½ è´¹å°½è¾›è‹¦ç»ˆäºæ”¹å®Œäº†æ‰€æœ‰çš„æŒ‡ä»¤çš„æ‰©å±•æ–¹å¼ï¼Œå´å¿˜äº†åœ¨æŸä¸€æ¡ä¸å¸¸ç”¨çš„æŒ‡ä»¤é‡Œé¢ä¹Ÿæ‹·è´äº†è¿™ä¸€ä»½ä»£ç ã€‚

--
count: false

å‡è®¾ç›¸åº”çš„å¯»å€æ–¹å¼ç”¨çš„éå¸¸å°‘ï¼Œç¼–è¯‘å™¨åªåœ¨éå¸¸å¥‡æ€ªçš„ä¸Šä¸‹æ–‡ä¸­æ‰ä¼šç”Ÿæˆè¿™ä¸€æ¡æŒ‡ä»¤ï¼Œäºæ˜¯ä½ åªèƒ½é¢å¯¹æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹éƒ½å¯ä»¥è·‘ï¼Œä½†è·‘nanos-liteè¿™äº›å¤§é¡¹ç›®æ—¶å°±ä¼šè«å`HIT BAD TRAP`çš„å´©æºƒåœºæ™¯ï¼ˆè¿›ä¸€æ­¥å‡è®¾è¿˜æ²¡æœ‰å·®åˆ†æµ‹è¯•ï¼‰ã€‚

--
count: false

----

> æ¶ˆé™¤é¡¹ç›®ä¸­çš„é‡å¤ä»£ç ä¹Ÿæ˜¯åœ¨èŠ‚çœæˆ‘ä»¬çš„æ—¶é—´

---

# ç¬¬ä¸€æ¬¡è¯‘ç æ‰§è¡Œè§£è€¦åˆ

cpu/exec/exec.c
```c
helper_fun opcode_table [256] = { add_r2rm_b, ... };
```

cpu/exec/arith/add-template.h
```c
#include "cpu/exec/template-start.h"

#define instr add

static void do_execute() {
  DATA_TYPE dst = op_dest->val + op_src->val;
  // update flags
}

make_instr_helper(i2a);
make_instr_helper(i2rm);

#include "cpu/exec/template-end.h"
```

---

# ç¬¬ä¸€æ¬¡è¯‘ç æ‰§è¡Œè§£è€¦åˆ

cpu/exec/arith/add.c
```c
#define DATA_BYTE 1
#include "add-template.h"
#undef DATA_BYTE

#define DATA_BYTE 2
#include "add-template.h"
#undef DATA_BYTE

#define DATA_BYTE 4
#include "add-template.h"
#undef DATA_BYTE
```

--
count:false

----

ç¬¬ä¸€æ¬¡ä¸å¤ªæˆåŠŸçš„è§£è€¦åˆä¹‹åçš„å¯ç¤ºï¼š

1. åŒä¸€æŒ‡ä»¤çš„ä¸åŒå®½åº¦å½¢å¼ï¼Œå¯ä»¥æ‹“å±•åˆ°åŒä¸€ä½å®½ä¹‹åè¿›è¡Œæ‰§è¡Œ
2. ä¸åŒæŒ‡ä»¤çš„ç›¸åŒè¯‘ç æ–¹å¼å¯ä»¥è¿›ä¸€æ­¥è§£è€¦(åœ¨è¡¨é¡¹ä¸­å°±æŒ‡æ˜è¯‘ç æ–¹å¼)

---

# ç¬¬äºŒæ¬¡è¯‘ç æ‰§è¡Œè§£è€¦åˆ

```c
typedef struct {
  DHelper decode;
  EHelper execute;
  int width;
} opcode_entry;

#define IDXW(id, ex, w) {concat(decode_, id), concat(exec_, ex), w}
#define IDX(id, ex) IDEXW(id, ex, 0)

opcode_entry opcode_table [512] = {
  /* 0x00 */ IDEXW(G2E, add, 1), IDEX(G2E, add), IDEXW(E2G, add, 1), IDEX(E2G, add),
  /* 0x04 */ IDEXW(I2a, add, 1), IDEX(I2a, add), EMPTY, EMPTY,
  /* .... */ // ...
};
```

---

# ç¬¬äºŒæ¬¡è¯‘ç æ‰§è¡Œè§£è€¦åˆ

çœ‹ç€ç•¥è›‹ç–¼ï¼Œæˆ‘ä»¬ç¨å¾®å±•å¼€ä¸€ä¸‹

```c
opcode_entry opcode_table [512] = {
  /* 0x00 */ {decode_G2E, exec_add, 1}, {decode_G2E, exec_add, 0}, {decode_E2G, exec_add, 1}, {decode_E2G, exec_add, 0},
  /* .... */ // ...
};
```

----
æ“ä½œç è¡¨çš„æ¯ä¸€é¡¹å˜æˆäº†ä¸‰å…ƒç»„`<decoder, executor, width>`ï¼Œè¿™æ ·ä»¥æ¥å¯¹äºä¸€ç§æŒ‡ä»¤æˆ‘ä»¬åªéœ€è¦å®ç°ä¸€ä¸ªexecutorï¼Œå¹¶ä¸”ä¸åŒæŒ‡ä»¤çš„ç›¸åŒè¯‘ç å½¢å¼å¯ä»¥å…±ç”¨decoderã€‚

> è§£è€¦åˆä¹‹åçš„nemuæ‰§è¡Œæ¯ä¸€æ¡æŒ‡ä»¤å‡ç”±ä¸‰ä¸ªè¿‡ç¨‹ç»„æˆï¼šè¯‘ç ã€æ‰§è¡Œã€æ›´æ–°pcï¼Œå®é™…ä¸Šè¿™ä¹Ÿæš—åˆcpuçš„å†…éƒ¨æ¶æ„ã€‚

---

# è§£è€¦åˆä¹‹åçš„nemu

æŒ‡ä»¤æ‰§è¡Œå‡½æ•°`exec_real`å…ˆå–ä¸€ä¸ªå­—èŠ‚çš„æŒ‡ä»¤ï¼ŒæŸ¥è¡¨å¾—å¯¹åº”çš„è¯‘ç å‡½æ•°å’Œæ‰§è¡Œå‡½æ•°ï¼Œå†äº¤ç”±`idex`è¿›è¡Œè¯‘ç æ‰§è¡Œã€‚

```c
make_EHelper(real) {
  uint32_t opcode = instr_fetch(eip, 1);
  decoding.opcode = opcode;
  set_width(opcode_table[opcode].width);
  idex(eip, &opcode_table[opcode]);
}

static inline void idex(vaddr_t *eip, opcode_entry *e) {
  if (e->decode)
    e->decode(eip);
  e->execute(eip);
}
```

---

# è¯‘ç å‡½æ•°ç¤ºä¾‹

```c
#define make_DHelper(name) void concat(decode_, name) (vaddr_t *eip)

static inline void decode_op_rm(vaddr_t *eip, Operand *rm, bool load_rm_val, Operand *reg, bool load_reg_val) {
  read_ModR_M(eip, rm, load_rm_val, reg, load_reg_val);
}

make_DHelper(G2E) {
  decode_op_rm(eip, id_dest, true, id_src, true);
}

```

----
äºæ˜¯ä½ å…´å¥‹çš„å±•å¼€äº†`read_ModR_M`å‡½æ•°ï¼Œå´å‘ç°æ¯ä¸€ä¸ªå•è¯éƒ½èƒ½è®¤è¯†ï¼Œå°±æ˜¯ä¸çŸ¥é“è¿™æ˜¯å¹²å˜›çš„ã€‚

å®é™…ä¸Šread_ModR_Mè¿™ä¸€éƒ¨åˆ†å±äºç¡¬ä»¶å¼ºç›¸å…³ä»£ç ï¼Œä½ ä»¬å¯ä»¥é€‰æ‹©é€šè¿‡é˜…è¯»i386æ‰‹å†Œæ¥äº†è§£ï¼Œä¸è¿‡å……æ»¡äººæ–‡å…³æ€€çš„yzhå­¦é•¿å·²ç»å¸®ä½ ä»¬å¤„ç†æ‰äº†è¿™ä¸ªé—®é¢˜ã€‚

---

public: true
class: center, middle

# ç®€å•çš„ç¡¬ä»¶æ¨¡æ‹Ÿ

---

# ä¸€ä¸ªALUè¿˜ä¸å¤Ÿ

æˆ‘ä»¬éœ€è¦è¾“å…¥è¾“å‡ºï¼Œæˆ‘ä»¬éœ€è¦å›¾å½¢ç•Œé¢ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çª—å£ç®¡ç†å™¨ã€å„ç§å°æ¸¸æˆã€‚

--
count:false

åœ¨æ•°ç”µè¯¾ä¸Šï¼Œä½ ä»¬å·²ç»å­¦ä¼šäº†å¦‚ä½•ç¼–å†™VGAæ§åˆ¶å™¨å’Œä¸²å£æ§åˆ¶å™¨ï¼Œç°åœ¨åªéœ€è¦å°†ä»–ä»¬æ¨¡æ‹Ÿä¸€éã€‚

--
count:false

----

cpuä¸¤ç§å¤–è®¾å¯»å€æ¨¡å¼

* memory mapped io (vaddr_read/vaddr_write)ï¼š

  * VGAã€MIPSæ¶æ„çš„å…¨éƒ¨å¤–è®¾å¯»å€æ–¹å¼

* port mapped io (pio_read/pio_write)ï¼š

  * x86çš„ç«¯å£ï¼ˆä¸²å£ã€nemuä¸­çš„é”®ç›˜å’Œæ—¶é’Ÿï¼‰

--
count:false

> æ¨¡æ‹Ÿå¤–è®¾å°±æ˜¯æ¨¡æ‹Ÿå¤–è®¾æä¾›çš„å¯„å­˜å™¨è¯»å†™è¡Œä¸ºï¼Œè€Œå¤–è®¾å¯„å­˜å™¨çš„è¯»å†™æš´éœ²åœ¨cpuçš„ä¸¤ç§å¤–è®¾å¯»å€æ¨¡å¼ä¸‹ã€‚

---

# nemuä¸­çš„è¾“å…¥è¾“å‡º(serial)

```c
#define SERIAL_PORT 0x3F8
#define CH_OFFSET 0
#define LSR_OFFSET 5

static uint8_t *serial_ch_base; /* character */
static uint8_t *serial_lsr_base; /* line status register */
static void serial_ch_io_handler(ioaddr_t addr, int len, bool is_write) {
  assert(is_write && len == 1); /* only simulate write */
  char c = serial_ch_base[0];
  putc(c, stdout);
  if(c == '\n') fflush(stdout);
}

void init_serial() {
  serial_ch_base = add_pio_map(SERIAL_PORT + CH_OFFSET, 1, serial_ch_io_handler);
  serial_lsr_base = add_pio_map(SERIAL_PORT + LSR_OFFSET, 1, NULL);
  serial_lsr_base[0] = 0x20; /* the status is always free */
}
```

---

# nemuçš„ç¡¬ä»¶è®¿é—®å›è°ƒæœºåˆ¶

src/device/io/port-io.c

```c
void *add_pio_map(); /* register callback and return registered virtual address */
```

----

å›è°ƒè§¦å‘çš„æ—¶æœºï¼š
* read:
  * pio_read_l/pio_read_w/pio_read_b
  * pio_read_common
  * pio_callback
* write (similar to read)

---
# nemuä¸­å…¶ä»–çš„ç¡¬ä»¶

* æ—¶é’Ÿ
 * gettimeofday
* é”®ç›˜
 * nemuä¸­é€šè¿‡SDLåº“çš„SDL_KEYDOWN/SDL_KEYUPäº‹ä»¶è·å–
* VGA (ç¼–å€åœ¨mmioä¸­)
 * é€šè¿‡è°ƒç”¨SDLåº“çš„SDL_Renderè¿›è¡Œæ¨¡æ‹Ÿ

--
count:false

----
> ä¸ºäº†é™ä½æ¨¡æ‹Ÿçš„å¤æ‚åº¦ï¼Œé”®ç›˜å¯ä»¥é€šè¿‡libc(scanf/getch)æ¥æ¨¡æ‹Ÿï¼Œä½†è¿™æ ·ä¸€æ¥æ–¹å‘é”®ã€Fç³»åˆ—æŒ‰é”®å°†ä¼šæ— æ³•æ¨¡æ‹Ÿï¼Œä½ çŸ¥é“å¦‚ä½•å¤„ç†è¿™ä¸ªé—®é¢˜å—ï¼Ÿï¼ˆæç¤ºï¼šANSI escape codeï¼‰

---

public: true
class: center, middle

# é€šå¾€æ›´é«˜é€Ÿçš„æ¬¡å…ƒ

(JITä¼˜åŒ–åˆæ­¥ä»‹ç»)

---

# RTLå¼€å§‹çš„æ—¶ä»£

åŒæ ·ä¸€æ¡æŒ‡ä»¤pushï¼Œå®ç°æ–¹å¼å´æœ‰ä¸€å †ï¼š

```c
cpu.esp -= 4;
vaddr_write(cpu.esp, *src1, 4);
```

```c
rtl_subi(&cpu.esp, 4);
vaddr_write(cpu.esp, *src1, 4);
```

```c
rtl_subi(&cpu.esp, 4);
rtl_sm(&cpu.esp, src1, 4);
```

--
count:false

----
> ä¼¼ä¹èƒ½é—´æ¥è¾…åŠ©æˆ‘ä»¬æ£€æµ‹ä½œå¼Š

---
# RTLå¼€å§‹çš„æ—¶ä»£

RTLçœŸæ­£çš„ç”¨é€”

* è®°å½•æŒ‡ä»¤æ‰§è¡Œçš„æ–¹å¼

--
count:false

è®°å½•æ‰§è¡Œæ–¹å¼æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

* æˆ‘ä»¬å¯ä»¥å¯¹æ‰§è¡Œæ–¹å¼åšä¸€äº›åˆ†æï¼Œç”šè‡³ä¼˜åŒ–
* äº‹å®è¯æ˜ï¼šé€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å¯ä»¥å°†nemuçš„æ€§èƒ½ä¼˜åŒ–20å€

---
# RTLå¼€å§‹çš„æ—¶ä»£

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¯„å­˜å™¨ä¹‹é—´çš„data dependency
 * è¯»åè¯» (no dependency)
 * è¯»åå†™ (false dependency)
 * å†™åè¯» (true dependency)
 * å†™åå†™ (false dependency)

--
count:false

----

false dependency:
 * æœ¬è´¨æ˜¯èµ„æºç«äº‰

true dependency:
 * æœ¬è´¨æ˜¯æ•°æ®æµä¾èµ–

---
# RTLå¼€å§‹çš„æ—¶ä»£

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œä»¥å†™åå†™ä¸ºä¾‹

* å¦‚æœæŸä¸€æ®µæŒ‡ä»¤æµè¿ç»­å¯¹æŸä¸€ä¸ªå¯„å­˜å™¨å‘ç”Ÿäº†å†™å…¥è¡Œä¸ºï¼Œé‚£ä¹ˆå…ˆå†™å…¥çš„å€¼æ¯«æ— ç–‘é—®ä¼šè¢«åå†™å…¥çš„å€¼è¦†ç›–æ‰ï¼Œé‚£ä¹ˆå®é™…ä¸Šé™¤äº†æœ€åä¸€ä¸ªå†™å…¥è¡Œä¸ºä¹‹å‰çš„å†™å…¥æ“ä½œéƒ½å¯ä»¥åˆ é™¤ã€‚

--
count:false

----

> çœŸå®çš„cpuä¸­é™¤äº†å†™åå†™è¿˜ä¼šé€šè¿‡å¯„å­˜å™¨é‡å‘½åå¤„ç†æ‰æ‰€æœ‰çš„è¯»åå†™ä¾èµ–ï¼Œä¸è¿‡åœ¨è™šæ‹Ÿæœºä¸­æˆ‘ä»¬æ²¡å¿…è¦å¤„ç†æ‰è¯»åå†™ã€‚

---

# RTLå¼€å§‹çš„æ—¶ä»£

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œä»¥å†™åå†™ä¸ºä¾‹

* ç¼–è¯‘å™¨ä¼˜åŒ–å¾ˆå°‘ä¼šç”Ÿæˆå†™åå†™çš„æŒ‡ä»¤ï¼Œä½†æ˜¯åœ¨nemuä¸­ï¼Œå†™åå†™çš„è¡Œä¸ºè¿˜æ˜¯æ™®éå­˜åœ¨ï¼š

```asm
addl $eax, $eax
addl $eax, $eax
```

åœ¨nemuä¸­ï¼Œè¿™ä¸¤æ¡addlæŒ‡ä»¤éƒ½ä¼šæ›´æ–°eflagï¼Œè€Œå®é™…ä¸Šç¬¬ä¸€æ¡addæŒ‡ä»¤çš„æ›´æ–°å®Œå…¨æ˜¯æ— æ„ä¹‰çš„ï¼Œå¹¶ä¸”æ›´æ–°eflagä¹Ÿæ˜¯ä¸€ä¸ªä»£ä»·å¾ˆé«˜çš„æ“ä½œã€‚

---
# RTLå¼€å§‹çš„æ—¶ä»£

å®Œæ•´çš„ä»¥rtlè¡¨è¿°çš„åŠ æ³•æŒ‡ä»¤ï¼ˆåŸºæœ¬éƒ½æ˜¯æ›´æ–°eflagæ“ä½œï¼‰ï¼š

```c
rtl_add(&t0, &id_dest->val, &id_src->val);
operand_write(id_dest, &t0);

rtl_update_ZFSF(&t0, id_dest->width);

// CF <- (result < dest)
rtl_setrelop(RELOP_LTU, &t1, &t0, &id_dest->val);
rtl_set_CF(&t1);

// OF <- (MSB[src] == MSB[dest] && MSB[result] != MSB[dest])
rtl_xor(&t1, &id_dest->val, &id_src->val);
rtl_not(&t1);
rtl_xor(&t2, &id_dest->val, &t0);
rtl_and(&t0, &t1, &t2);
rtl_msb(&t0, &t0, id_dest->width);
rtl_set_OF(&t0);
```

---
# RTLå¼€å§‹çš„æ—¶ä»£

å¤„ç†æ‰æ‰€æœ‰å†™åå†™çš„é€šç”¨æ–¹æ¡ˆï¼Œæ­»ä»£ç æ¶ˆé™¤(dce)

* å€’æ’ä¸€ä¸ªåŸºæœ¬å—å†…æŒ‡ä»¤æµçš„è¯»å†™ä¾èµ–
* å°†åŒ…æ‹¬é€šç”¨å¯„å­˜å™¨ã€RTLæ‰©å±•çš„å¯„å­˜å™¨ã€eflagå‡æ‰“ä¸Šè¯»å†™æ ‡è®°
* ä¿ç•™å¯¹æŸä¸€ä¸ªå¯„å­˜å™¨è¿ç»­å†™å…¥æ“ä½œçš„æœ€åä¸€ä¸ªå†™å…¥æ“ä½œ

--
count:false

----

ä¿å®ˆé¢„ä¼°è·‘åˆ†ï¼š 80 -> 800

è·‘åˆ†æš´æ¶¨çš„ä¸¤ä¸ªåŸå› ï¼š
 * RTLå±‚è®°å½•äº†æŒ‡ä»¤çš„è¯‘ç æ–¹å¼ï¼Œä¸ç”¨å†é‡å¤è¯‘ç 
 * æ­»ä»£ç æ¶ˆé™¤å¤„ç†æ‰äº†å¤šä½™çš„å†™åå†™

---
# RTLå¼€å§‹çš„æ—¶ä»£

ä¸€äº›å…¶ä»–çš„ä¼˜åŒ–æ–¹æ¡ˆ

* switch-caseä¼˜åŒ–æ‰å‡½æ•°æŒ‡é’ˆè¡¨
  * 800 -> 1000
* è·³è½¬è¡¨ä¼˜åŒ–
  * 1000 -> 1400
* å¸¸é‡æŠ˜å 
  * 1400 -> 2000
* binary translator
  * è‡³å°‘5000
* qemuå‚è€ƒå®ç°: 10000ï¼Œkvmå®ç°: 100000

---
# RTLå¼€å§‹çš„æ—¶ä»£

ä¸€äº›å‚è€ƒè·‘åˆ†ï¼š

* 200ï¼Œèƒ½å¤Ÿå¾ˆå¡çš„ç©ä»™å‰‘
* 800ï¼Œèƒ½å¤Ÿæµç•…çš„ç©ä»™å‰‘
* 1400ï¼Œèƒ½å¤Ÿåœ¨ä»™å‰‘é‡Œé¢æµç•…çš„å‘å¤§æ‹›
* 2000ï¼Œèƒ½å¤Ÿæµç•…çš„ç©è¶…çº§é©¬é‡Œå¥¥

---

public: true
class: center, middle

# æ›´é«˜æ•ˆçš„è°ƒè¯•/"ä½œå¼Š"æ–¹å¼

---

# ç—›è‹¦çš„è°ƒè¯•ç»å†

æ¥è‡ªæŸä½PAç»å†è€…çš„[äº²èº«ç»å†](https://www.zhihu.com/question/64475453/answer/224647520)

----

èµ·å› 
* ä¸æ˜(æš‚å®š)

ç°è±¡
* cputestsä¸­é™¤äº†matrix-mul-bigå…¶ä»–éƒ½èƒ½è¿‡

æ¡ä»¶
* cputestsä¸­æ²¡æœ‰printfã€æ²¡æœ‰å·®åˆ†æµ‹è¯•ã€æ²¡æœ‰AM

---

# ç—›è‹¦çš„è°ƒè¯•ç»å†

é€šè¿‡å†…è”æ±‡ç¼–åœ¨matrix-mul-bigä¸­æ‰“å°ä¸€äº›è°ƒè¯•ä¿¡æ¯
* matrix-mul-bigå¯ä»¥HIT GOOD TRAP

åˆ é™¤ä»…æœ‰çš„logä¹‹å
* matrix-mul-bigåˆä¼šGIT BAD TRAP

----

> çœŸæ­£éš¾è°ƒè¯•çš„bugä¸ä»…éš¾äºå®šä½ï¼Œç”šè‡³è¿˜ä¼šèº²ç€ä½ ã€‚
>     -- æ²ƒâ€¢é•ƒåŸºâ€¢ç¡•å¾·

---

# å·®åˆ†æµ‹è¯•çš„é‡è¦æ„ä¹‰

ä½ çš„æŸæ¡æŒ‡ä»¤å¦‚æœå®ç°é”™äº†ï¼Œå·®åˆ†æµ‹è¯•ä¼šåœ¨ç¬¬ä¸€æ—¶é—´æ±‡æŠ¥ç»™ä½ ï¼Œè€Œä¸è‡³äºåƒæ»šé›ªçƒä¸€æ ·ï¼Œç­‰ä½ å‘ç°bugï¼Œç¦»å‡ºé”™çš„åœ°ç‚¹å·²ç»é¥ä¸å¯åŠã€‚

--
count:false

----

åˆæ˜¯æŸä½å­¦é•¿çš„äº²èº«ç»å†ï¼š

åœ¨ç¬¬äºŒå±Š****æ¯”èµ›ä¸­ï¼Œç¦»å†³èµ›æäº¤è¿˜å‰©ä¸€ä¸ªæ˜ŸæœŸçš„æ—¶å€™ï¼Œyzhçªç„¶è®©lzgå®ç°ä¸€ä¸‹ä¹±åºæ ¸å¿ƒï¼Œå¹¶è®©oxfå®ç°ä¸€ä¸‹mmuï¼Œæœ€ç»ˆè¿™ä¸¤ä¸ªç‰¹æ€§éƒ½ä½œä¸ºäº®ç‚¹åŠ å…¥åˆ°äº†å†³èµ›æäº¤çš„ä½œå“ä¸­ï¼Œè€Œèƒ½å®Œæˆè¿™ä¸€å£®ä¸¾çš„å…³é”®ï¼Œå°±åœ¨äºå·®åˆ†æµ‹è¯•ã€‚

æ¯”èµ›ä¸€å¼€å§‹ï¼Œé˜Ÿä¼ä¾¿å®ç°äº†ä¸€ä¸ªmips32çš„æ¨¡æ‹Ÿå™¨ï¼Œéšåä¸€ç›´è·Ÿè¿›ç¡¬ä»¶çš„å®ç°åŒæ­¥æ¼”åŒ–ã€‚åœ¨ç¡¬ä»¶ç”µè·¯ä¸ŠåŠ æŒ‡ä»¤ã€æ–°ç‰¹æ€§æˆ–å¤–è®¾ä¹‹å‰ï¼Œå…ˆåœ¨æ¨¡æ‹Ÿå™¨ä¸Šè·‘é€šï¼Œç„¶åå†è®©ç¡¬ä»¶å®ç°è·Ÿæ¨¡æ‹Ÿå™¨è¿›è¡Œå·®åˆ†ã€‚

---

# nemuä¸Šçš„å·®åˆ†æµ‹è¯•åŸç†

æ¶‰åŠåˆ°çš„æºæ–‡ä»¶
* src/monitor/diff-test/
* tools/qemu-diff/

åŸºæœ¬è¿‡ç¨‹
* **nemué€šè¿‡gdb serial protocolå‘qemuæœåŠ¡å™¨é€šä¿¡**
  * https://sourceware.org/gdb/current/onlinedocs/gdb/Remote-Protocol.html#Remote-Protocol
* nemuæ¯æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ä¹‹åï¼Œéƒ½å‘é€è¯·æ±‚ï¼Œè®©qemuä¹Ÿæ‰§è¡Œä¸€æ¡æŒ‡ä»¤
* qemuæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œnemuè¯·æ±‚æ‰€æœ‰çš„å¯„å­˜å™¨ä¿¡æ¯ï¼Œç„¶åä¸æœ¬åœ°å¯„å­˜å™¨è¿›è¡Œæ¯”å¯¹

---

# æ›´å®ç”¨çš„è°ƒè¯•å™¨

å‡è®¾ä½ åœ¨nemuçš„naiveçš„è°ƒè¯•å™¨ä¸­æƒ³è¦æ‰§è¡Œä¸‹é¢ä¸€æ¡è¯­å¥
* `x/32w ((struct _RegSet *)pcb->regs)->esp`

åœ¨ä½ çš„naiveçš„è°ƒè¯•å™¨ä¸­éå¸¸éš¾å®ç°
* éœ€è¦è¯»ç¬¦å·è¡¨ã€æ›´å®Œå–„çš„è¡¨è¾¾å¼æ±‚å€¼å™¨ã€...

--
count:false

----

åŸºäºgdb serial protocolçš„å®ç”¨è°ƒè¯•å™¨
* åœ¨nemuä¸­å®ç°gdb stuff
* å¯åŠ¨nemuæ—¶forkå‡ºgdbå­è¿›ç¨‹ä½¿å…¶ä¸nemué€šä¿¡
* å‘gdbè¾“å…¥è°ƒè¯•æŒ‡ä»¤ï¼Œgdbå°†è°ƒè¯•æŒ‡ä»¤ç¿»è¯‘æˆåŸè¯­å‘é€ç»™nemu
* nemuåªéœ€è¦æ‰§è¡Œä¸€äº›ç®€å•çš„åŸè¯­å°±å¯ä»¥è·å¾—ä¸€ä¸ªå¼ºåŠ›çš„è°ƒè¯•å™¨

---

# æ›´å®ç”¨çš„è°ƒè¯•å™¨

ä¸€äº›éœ€è¦å®ç°çš„åŸè¯­
* gdb_read_registers / gdb_write_registers
* gdb_read_memory / gdb_write_memory
* gdb_single_step / gdb_continue
* gdb_insert_breakpoint / gdb_remove_breakpoint (éå¿…é¡»)

--
count:false

----

åœ¨ä¹‹å‰æ‰€è¯´çš„å¤§èµ›ä¸­ï¼Œæˆ‘ä»¬çš„é˜Ÿä¼ç¼–å†™çš„nemu-mips32æ¨¡æ‹Ÿå™¨ä¾¿ä½¿ç”¨äº†è¿™æ ·çš„è°ƒè¯•å™¨æ¥è°ƒè¯•linuxï¼ˆè™½ç„¶æœ€åæ²¡èƒ½è°ƒé€šï¼‰ã€‚

---

# æ¨èçš„å‚è€ƒä»£ç 

äº’è”ç½‘åšå®¢/é—®ç­”

* ğŸš« ä¸æ¨èCSDN/cnblogs/...çš„ä»£ç  (å‚å·®ä¸é½)
* âœ… Stackoverflowä¸Šçš„é«˜ç¥¨å›ç­”

å‚è€ƒä»£ç  (RTFSC)

* æš‚æ—¶æ²¡æœ‰æƒ³åˆ°å¥½çš„ICSå‚è€ƒä»£ç ã€‚æƒ³åˆ°å¯ä»¥å‘Šè¯‰æˆ‘ã€‚QEMUå¥½åƒå¤ªå¤æ‚äº†ç‚¹ã€‚
* OSè¯¾çš„å‚è€ƒä»£ç ï¼šbusybox (æœ¬è¯¾ç¨‹ä¹Ÿæ¨è), newlib, xv6 (è¿›é˜¶)
    * å°±åƒå¤§å®¶éƒ½å–œæ¬¢æŠŠæ¯å¤©èº«è¾¹ç”¨çš„ä¸œè¥¿æ‹†äº†çœ‹çœ‹æ€ä¹ˆå·¥ä½œçš„ï¼Œbusyboxå°±æ˜¯ä¸ªä¸é”™çš„ç®€åŒ–ç‰ˆ

</textarea>

<script src="/static/js/remark-latest.min.js"></script>

<script>
  var slideshow = remark.create();
  // $('.remark-slide-content').quickfit({'font-size':12px});
</script>

    <script>
      $("math").each(function() {
        var tex = $(this).text();
        var html = katex.renderToString(tex, {
          throwOnError: false
        });
        $(this).replaceWith(html);
      });
    </script>
  </body>
</html>
